<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="manualstitch.css">
  <meta charset="UTF-8">
  <title>Manual Stitcher</title>
  <script src="https://cdn.jsdelivr.net/npm/konva@8.3.1/konva.min.js"></script>
  <style>
    #container {
      width: 1600px;
      height: 1200px;
      border: 1px solid #ccc;
    }

    .file-input input[type="file"] {
      display: none;
    }
    
  </style>
</head>
<body>
  <div class="buttons">
    <div class="boxy">
      <a href="#" class="box">
        <button onclick="clearImages()" class="box-content">Clear Images</button>
      </a>
      <a href="#" class="box">
        <input type="file" id="image-upload" accept="image/*" multiple class="box-content">
      </a>

      <a href="#" class="box">
        <button onclick="saveImage()" class="box-content">Save Image</button>
      </a>
      
      <a href="../index.html" class="box">
        <button class="box-content">
          <p>Go Back ‚Üê</p>
        </button>
      </a>
    </div>
    <hr class="line">
  </div>
  <div id="container"></div>
  <div>
    <label for="opacity">Opacity:</label>
    <input type="range" id="opacity" min="0" max="1" step="0.01" value="1" onchange="changeOpacity(this.value)">
  </div>
  <script>
// Create a stage
var stage = new Konva.Stage({
      container: 'container',
      width: 1600,
      height: 1200
    });

    // Create a layer
    var layer = new Konva.Layer();
    stage.add(layer);

    // Array to store images
    var images = [];

    // Function to load an image
    function loadImage(file) {
      var reader = new FileReader();
      reader.onload = function(event) {
        var imageObj = new Image();
        imageObj.onload = function() {
          var konvaImage = new Konva.Image({
            image: imageObj,
            draggable: true
          });
          konvaImage.on('dragmove', function() {
            lastMovedImage = this; // Update last moved image reference
          });
          images.push(konvaImage);
          layer.add(konvaImage);
          layer.batchDraw();
        };
        imageObj.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Handle image upload
    var imageUpload = document.getElementById('image-upload');
    imageUpload.addEventListener('change', function(event) {
      var files = event.target.files;
      for (var i = 0; i < files.length; i++) {
        loadImage(files[i]);
      }
    });

    // Register drag events for all images
    layer.on('dragstart', function(event) {
      var image = event.target;
      image.moveToTop();
      layer.draw();
    });

    // Add the layer to the stage
    stage.add(layer);


    function saveImage() {
      // Save the image
      var dataURL = stage.toDataURL({ pixelRatio: images.length});
      var link = document.createElement('a');
      link.href = dataURL;
      link.download = 'image.png';
      link.click();
    }

    function handleScroll(event) {
      var scaleBy = 1.05;
      event.preventDefault();

      var oldScale = stage.scaleX();
      var mousePointTo = {
        x: stage.getPointerPosition().x / oldScale - stage.x() / oldScale,
        y: stage.getPointerPosition().y / oldScale - stage.y() / oldScale
      };

      var newScale = event.deltaY < 0 ? oldScale * scaleBy : oldScale / scaleBy;

      stage.scale({ x: newScale, y: newScale });

      var newPos = {
        x: -(mousePointTo.x - stage.getPointerPosition().x / newScale) * newScale,
        y: -(mousePointTo.y - stage.getPointerPosition().y / newScale) * newScale
      };
      stage.position(newPos);
      stage.batchDraw();
    }

    // Add scroll event listener
    var container = document.getElementById('container');
    container.addEventListener('wheel', handleScroll, { passive: false });

    // Remove scroll event listener when dragging
    stage.on('dragstart', function() {
      container.removeEventListener('wheel', handleScroll);
    });

    stage.on('dragend', function() {
      container.addEventListener('wheel', handleScroll, { passive: false });
    });

    function changeOpacity(value) {
      // Set the opacity of the last moved image
      if (lastMovedImage) {
        lastMovedImage.opacity(value);
        layer.batchDraw();
      }
    }

    function clearImages() {
      layer.removeChildren();
      images = [];
      stage.batchDraw();
    }
  </script>
</body>
</html>

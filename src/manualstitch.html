<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="./manualstitch.css">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'"> -->
    <title>Manual Image Stitcher</title>
    <script src="https://cdn.jsdelivr.net/npm/konva@8.3.1/konva.min.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <link rel="stylesheet" href="../sass/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    #container {
      width: 100%;
      height: 85vh;
      border: 1px solid #ccc;
      overflow: hidden;
    }

    .file-input input[type="file"] {
      display: none;
    }

    #opacityRange {
      width: 15%;
    }
    
  </style>
</head>
<body>

  <div class="d-flex align-items-center">
    <a href="./index.html" class="btn btn-secondary btn-lg m-2" role="button" data-bs-toggle="tooltip" data-bs-placement="top" id="backtour" title="Click here to go back to the home screen">
      <i class="bi bi-arrow-left-circle"></i> Back
    </a>
    <label for="image-upload" class="btn btn-primary btn-lg m-2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Click here to upload images for auto-stitching" id="addtour">
      <i class="bi bi-plus-circle"></i> </i> Add Images
      <input type="file" id="image-upload" accept="image/*" multiple style="display: none;">
    </label>
    <button onclick="saveImage()" class="btn btn-primary btn-lg m-2" id="savetour"><i class="bi bi-download"></i> Save Image</button>
    
    <button onclick="clearImages()" id="clear-images-button" class="btn btn-primary btn-lg m-2"><i class="bi bi-x-circle"></i> Clear Images</button>
    <label for="opacity" class="form-label m-2" style="color: #ccc;">Opacity:</label>
    <input type="range" id="opacityRange" min="0" max="1" step="0.1" value="1" class="form-range">
    <div id="info-output" class="alert alert-info d-none m-0 ms-auto "  role="alert"></div>
    <button type="button" id='tourtour' class="btn btn-outline-info btn-lg m-2 ms-auto" onclick="startTour()" data-bs-toggle="tooltip" data-bs-placement="top" title="Click here to get a tour of the page">
      <i class="bi bi-book"></i> Tour
    </button>
  </div>

  <div id="container"></div>
  <div class="footer">
    <p style="margin-top: 8px; margin-bottom: 8px; margin-left: 8px;">Made with ❤️ by <a class="footlink" target="_blank" href="https://www.sakec.ac.in/"><b>Shah & Anchor Kutchhi Engineering College</b></a></p>
  </div>   
  <script>
    // const { Konva } = require('konva')
    // const { ipcRenderer } = require('electron');
    noOfImagesAddedToManualStitcher = 0;
    // Create a stage
    var stage = new Konva.Stage({
          container: 'container',
          width: 1600,
          height: 1200
        });

    // Create a layer
    var layer = new Konva.Layer();
    stage.add(layer);

    
    // Array to store the images
    var images = [];

    // Array to store the tooltips
    var tooltips = [];

    
    // Function to load and display the image
    function loadImage(file) {
      var reader = new FileReader();
      reader.onload = function(event) {
        var imageObj = new Image();
        imageObj.onload = function() {
          var konvaImage = new Konva.Image({
            image: imageObj,
            draggable: true
          });
          konvaImage.name(file.name);
          
          var tooltip = new Konva.Label({
            opacity: 0.75
          });

          var tooltipText = new Konva.Text({
            text: konvaImage.name(),
            fontFamily: 'Arial',
            fontSize: 12,
            padding: 5,
            fill: 'white'
          });

          tooltip.add(tooltipText);
          tooltips.push(tooltip);

          konvaImage.on('dragmove', function() {
            lastMovedImage = this; // Update last moved image reference
            var position = this.position();
            tooltip.position({
              x: position.x,
              y: position.y + this.height()
            });
            layer.batchDraw();
          });

          konvaImage.on('mouseover', function() {
            var position = this.position();
            tooltip.position({
              x: position.x,
              y: position.y + this.height()
            });
            layer.add(tooltip);
            layer.batchDraw();
          });

          konvaImage.on('mouseout', function() {
            tooltip.remove();
            layer.batchDraw();
          });

          images.push(konvaImage);
          layer.add(konvaImage);
          layer.batchDraw();
        };
        imageObj.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }


    // Handle image upload
    var imageUpload = document.getElementById('image-upload');
    imageUpload.addEventListener('change', function(event) {
      var files = event.target.files;
      for (var i = 0; i < files.length; i++) {
        loadImage(files[i]);
      }
      noOfImagesAddedToManualStitcher += files.length;
      localStorage.setItem('noOfImagesAddedToManualStitcher',noOfImagesAddedToManualStitcher );
      var alertInfo = document.getElementById('info-output');      
      alertInfo.classList.remove('d-none');
      alertInfo.innerHTML = '<i class="bi bi-info-circle-fill"></i> '+files.length+' Image(s) Added to Manual Stitcher'; 
      setTimeout(function() {
        alertInfo.classList.add('d-none');
        alertInfo.innerHTML = '';
      }, 2000);
    });

    var opacityRange = document.getElementById('opacityRange');
    opacityRange.oninput = function() {
      const opacityValue = opacityRange.value;
      var alertInfo = document.getElementById('info-output');      
      alertInfo.classList.remove('d-none');
      alertInfo.innerHTML = '<i class="bi bi-info-circle-fill"></i> Opacity Set to ' + opacityRange.value*100 + '%'; 
      setTimeout(function() {
        alertInfo.classList.add('d-none');
        alertInfo.innerHTML = '';
      }, 2000);
    };


    // Register drag events for all images
    layer.on('dragstart', function(event) {
      var image = event.target;
      image.moveToTop();
      
      // Get the opacity value from the range input
      var opacityValue = opacityRange.value;
      image.opacity(opacityValue);
      layer.draw();
    });

    // Reset opacity when drag ends
    layer.on('dragend', function(event) {
      var image = event.target;
      image.opacity(1); // Reset the opacity to 100% (1)

      layer.draw();
    });

    // Add the layer to the stage
    stage.add(layer);


    function saveImage() {
      // Store the current stage scale
      var originalScale = stage.scaleX();
      // Store the original stage size and position
      var originalStageWidth = stage.width();
      var originalStageHeight = stage.height();
      var originalStagePosition = stage.position()

      // Reset the stage scale to 1
      stage.scale({ x: 1, y: 1 });
      stage.position({ x: 0, y: 0 });

      // Find the bounding box of all images
      var imageShapes = stage.find('Image');
      
      var minX = Number.MAX_SAFE_INTEGER;
      var minY = Number.MAX_SAFE_INTEGER;
      var maxX = Number.MIN_SAFE_INTEGER;
      var maxY = Number.MIN_SAFE_INTEGER;

      imageShapes.forEach(function(shape) {
        var box = shape.getClientRect();
        minX = Math.min(minX, box.x);
        minY = Math.min(minY, box.y);
        maxX = Math.max(maxX, box.x + box.width);
        maxY = Math.max(maxY, box.y + box.height);
      });

      var boundingBox = {
        x: minX,
        y: minY,
        width: maxX - minX,
        height: maxY - minY
      };

      // Adjust the stage size based on the bounding box
      stage.width(boundingBox.width);
      stage.height(boundingBox.height);
      stage.position({
        x: -boundingBox.x,
        y: -boundingBox.y
      });

      // Save the cropped image
      var dataURL = stage.toDataURL({ pixelRatio: 1 });
      var link = document.createElement('a');
      link.href = dataURL;
      link.download = 'image.png';
      link.click();
      console.log('Saved imagye!');
      // Restore the original stage size and position
      stage.width(originalStageWidth);
      stage.height(originalStageHeight);
      stage.position(originalStagePosition);
      stage.scale({ x: originalScale, y: originalScale });

      var alertInfo = document.getElementById('info-output');      
      alertInfo.classList.remove('d-none');
      alertInfo.innerHTML = '<i class="bi bi-info-circle-fill"></i> Stitched image saved to your device!'; 
      setTimeout(function() {
        alertInfo.classList.add('d-none');
        alertInfo.innerHTML = '';
      }, 5000);
    }

    function handleScroll(event) {
      var scaleBy = 1.05;
      event.preventDefault();

      var oldScale = stage.scaleX();
      var mousePointTo = {
        x: stage.getPointerPosition().x / oldScale - stage.x() / oldScale,
        y: stage.getPointerPosition().y / oldScale - stage.y() / oldScale
      };

      var newScale = event.deltaY < 0 ? oldScale * scaleBy : oldScale / scaleBy;

      stage.scale({ x: newScale, y: newScale });

      var newPos = {
        x: -(mousePointTo.x - stage.getPointerPosition().x / newScale) * newScale,
        y: -(mousePointTo.y - stage.getPointerPosition().y / newScale) * newScale
      };
      stage.position(newPos);
      stage.batchDraw();
    }

    // Add scroll event listener
    var container = document.getElementById('container');
    container.addEventListener('wheel', handleScroll, { passive: false });

    // Remove scroll event listener when dragging
    stage.on('dragstart', function() {
      container.removeEventListener('wheel', handleScroll);
    });

    stage.on('dragend', function() {
      container.addEventListener('wheel', handleScroll, { passive: false });
    });

    function clearImages() {
      var clearImagesButton = document.getElementById('clear-images-button');
      layer.removeChildren();
      images = [];
      stage.batchDraw();
      localStorage.getItem('noOfImagesAddedToManualStitcher',noOfImagesAddedToManualStitcher );
      clearImagesButton.innerHTML = '<i class="bi bi-trash"></i> Clear Images';
      var alertInfo = document.getElementById('info-output');      
      alertInfo.classList.remove('d-none');
      alertInfo.innerHTML = '<i class="bi bi-info-circle-fill"></i> '+noOfImagesAddedToManualStitcher+' Images Removed From Canvas'; 
      localStorage.setItem('noOfImagesAddedToManualStitcher',noOfImagesAddedToManualStitcher );
      setTimeout(function() {
        alertInfo.classList.add('d-none');
        alertInfo.innerHTML = '';
        clearImagesButton.innerHTML = '<i class="bi bi-x-circle"></i> Clear Images'; 
      }, 2000);
      noOfImagesAddedToManualStitcher = 0;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const Shepherd = require('shepherd.js')
    let tour = null;

    function startTour() {
      if (tour) {
        tour.start();
        return;
      }
    }

    tour = new Shepherd.Tour({
      useModalOverlay: true,
    });

    steps=[{
      id: 'step1',
      title: 'Go Back',
      text: 'Click this  button to Go back to Homepage.',
      attachTo: {
        element: '#backtour',
        on: 'bottom',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
        {
        text: 'Exit Tour',
        action: tour.cancel
      },
      ],
    },
    {
      id: 'step2',
      title: 'Add Images',
      text: 'Click this button to upload your images to the Manual stitcher.',
      attachTo: {
        element: '#addtour',
        on: 'bottom',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
        {
        text: 'Exit Tour',
        action: tour.cancel
      },
      ],
    },
    {
      id: 'step3',
      title: 'Save Image',
      text: 'Click this button to save the manually stitched images as a single image.',
      attachTo: {
        element: '#savetour',
        on: 'bottom',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
        {
        text: 'Exit Tour',
        action: tour.cancel
      },
      ],
    },
    {
      id: 'step4',
      title: 'Clear Images',
      text: 'Click this button to clear all the images present in the canvas.',
      attachTo: {
        element: '#clear-images-button',
        on: 'bottom',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
        {
        text: 'Exit Tour',
        action: tour.cancel
      },
      ],
    },
    {
      id: 'step5',
      title: 'Step 5',
      text: 'This is the opacity range slider,drag the range to change the opacity of the image when clicked.',
      attachTo: {
        element: '#opacityRange',
        on: 'top',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
        {
        text: 'Exit Tour',
        action: tour.cancel
      },
      ],
    },
    {
      id: 'step6',
      title: 'The Canvas',
      text: 'This is the canvas area, you can use your scrollwheel to zoom in and out in the canvas - scroll up to zoom in, scroll down to zoom out.',
      attachTo: {
        element: '#container',
        on: 'top',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
        {
        text: 'Exit Tour',
        action: tour.cancel
      },
      ],
    },
    {
      id: 'step7',
      title: 'Step 6',
      text: 'This is the canvas area, you can use your scrollwheel to zoom in and out in the canvas - scroll up to zoom in, scroll down to zoom out.',
      attachTo: {
        element: '#tourtour',
        on: 'bottom',
      },
      classes: 'step-class',
      buttons: [
        {
        text: 'Exit Tour',
        action: tour.cancel
      },
      ],
    },
  ];

    tour.addSteps(steps);

    tour.defaultStepOptions = {
      classes: 'shepherd-theme-arrows',
      scrollTo: true,
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
      ],
    };

  </script>
</body>
</html>

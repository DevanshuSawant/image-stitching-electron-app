<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="./manualstitch.css">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'"> -->
    <title>Manual Stitcher</title>
    <script src="https://cdn.jsdelivr.net/npm/konva@8.3.1/konva.min.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <link rel="stylesheet" href="../sass/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
  <style>
    #container {
      width: 100%;
      height: 85vh;
      border: 1px solid #ccc;
      overflow: hidden;
    }

    .file-input input[type="file"] {
      display: none;
    }
    
  </style>
</head>
<body>
  <div class="buttons">
    <div class="boxy">
      <a href="#" class="box">
        <button onclick="clearImages()" class="box-content">Clear Images</button>
      </a>
      <a href="#" class="box">
        <label for="image-upload" class="box-content">Upload Files</label>
        <input type="file" id="image-upload" accept="image/*" multiple class="box-content">
      </a>
      <a href="#" class="box">
        <button onclick="saveImage()" class="box-content">Save Image</button>
      </a>
      <a href="./index.html" class="box">
        <button class="box-content">
          <p>Go Back ←</p>
        </button>
      </a>
      <div>
        <label for="opacity">Opacity:</label>
        <input type="range" id="opacityRange" min="0" max="1" step="0.1" value="1" class="form-range">
      </div>
      <a href="#" class="box">
        <button onclick="startTour()" class="box-content">Start Tour</button>
      </a>
    </div>
  </div>
  <div id="container"></div>
  <div class="footer">
    <p>Made with ❤️ by <a class="footlink" target="_blank" href="https://www.sakec.ac.in/"><b>Shah & Anchor Kutchhi Engineering College</b></a></p>
  </div>
  <script>
    // const { Konva } = require('konva')
    // const { ipcRenderer } = require('electron');

    // Create a stage
    var stage = new Konva.Stage({
          container: 'container',
          width: 1600,
          height: 1200
        });

    // Create a layer
    var layer = new Konva.Layer();
    stage.add(layer);

    
    // Array to store the images
    var images = [];

    // Array to store the tooltips
    var tooltips = [];

    
    // Function to load and display the image
    function loadImage(file) {
      var reader = new FileReader();
      reader.onload = function(event) {
        var imageObj = new Image();
        imageObj.onload = function() {
          var konvaImage = new Konva.Image({
            image: imageObj,
            draggable: true
          });
          konvaImage.name(file.name);
          
          var tooltip = new Konva.Label({
            opacity: 0.75
          });

          var tooltipText = new Konva.Text({
            text: konvaImage.name(),
            fontFamily: 'Arial',
            fontSize: 12,
            padding: 5,
            fill: 'white'
          });

          tooltip.add(tooltipText);
          tooltips.push(tooltip);

          konvaImage.on('dragmove', function() {
            lastMovedImage = this; // Update last moved image reference
            var position = this.position();
            tooltip.position({
              x: position.x,
              y: position.y + this.height()
            });
            layer.batchDraw();
          });

          konvaImage.on('mouseover', function() {
            var position = this.position();
            tooltip.position({
              x: position.x,
              y: position.y + this.height()
            });
            layer.add(tooltip);
            layer.batchDraw();
          });

          konvaImage.on('mouseout', function() {
            tooltip.remove();
            layer.batchDraw();
          });

          images.push(konvaImage);
          layer.add(konvaImage);
          layer.batchDraw();
        };
        imageObj.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }


    // Handle image upload
    var imageUpload = document.getElementById('image-upload');
    imageUpload.addEventListener('change', function(event) {
      var files = event.target.files;
      for (var i = 0; i < files.length; i++) {
        loadImage(files[i]);
      }
    });

    var opacityRange = document.getElementById('opacityRange');
    // Register drag events for all images
    layer.on('dragstart', function(event) {
      var image = event.target;
      image.moveToTop();
      
      // Get the opacity value from the range input
      var opacityValue = opacityRange.value;
      image.opacity(opacityValue);

      layer.draw();
    });

    // Reset opacity when drag ends
    layer.on('dragend', function(event) {
      var image = event.target;
      image.opacity(1); // Reset the opacity to 100% (1)

      layer.draw();
    });

    // Add the layer to the stage
    stage.add(layer);


    function saveImage() {
      // Store the current stage scale
      var originalScale = stage.scaleX();
      // Store the original stage size and position
      var originalStageWidth = stage.width();
      var originalStageHeight = stage.height();
      var originalStagePosition = stage.position()

      // Reset the stage scale to 1
      stage.scale({ x: 1, y: 1 });
      stage.position({ x: 0, y: 0 });

      // Find the bounding box of all images
      var imageShapes = stage.find('Image');
      
      var minX = Number.MAX_SAFE_INTEGER;
      var minY = Number.MAX_SAFE_INTEGER;
      var maxX = Number.MIN_SAFE_INTEGER;
      var maxY = Number.MIN_SAFE_INTEGER;

      imageShapes.forEach(function(shape) {
        var box = shape.getClientRect();
        minX = Math.min(minX, box.x);
        minY = Math.min(minY, box.y);
        maxX = Math.max(maxX, box.x + box.width);
        maxY = Math.max(maxY, box.y + box.height);
      });

      var boundingBox = {
        x: minX,
        y: minY,
        width: maxX - minX,
        height: maxY - minY
      };

      // Adjust the stage size based on the bounding box
      stage.width(boundingBox.width);
      stage.height(boundingBox.height);
      stage.position({
        x: -boundingBox.x,
        y: -boundingBox.y
      });

      // Save the cropped image
      var dataURL = stage.toDataURL({ pixelRatio: 1 });
      var link = document.createElement('a');
      link.href = dataURL;
      link.download = 'image.png';
      link.click();
      console.log('Saved imagye!');
      // Restore the original stage size and position
      stage.width(originalStageWidth);
      stage.height(originalStageHeight);
      stage.position(originalStagePosition);
      stage.scale({ x: originalScale, y: originalScale });
    }

    function handleScroll(event) {
      var scaleBy = 1.05;
      event.preventDefault();

      var oldScale = stage.scaleX();
      var mousePointTo = {
        x: stage.getPointerPosition().x / oldScale - stage.x() / oldScale,
        y: stage.getPointerPosition().y / oldScale - stage.y() / oldScale
      };

      var newScale = event.deltaY < 0 ? oldScale * scaleBy : oldScale / scaleBy;

      stage.scale({ x: newScale, y: newScale });

      var newPos = {
        x: -(mousePointTo.x - stage.getPointerPosition().x / newScale) * newScale,
        y: -(mousePointTo.y - stage.getPointerPosition().y / newScale) * newScale
      };
      stage.position(newPos);
      stage.batchDraw();
    }

    // Add scroll event listener
    var container = document.getElementById('container');
    container.addEventListener('wheel', handleScroll, { passive: false });

    // Remove scroll event listener when dragging
    stage.on('dragstart', function() {
      container.removeEventListener('wheel', handleScroll);
    });

    stage.on('dragend', function() {
      container.addEventListener('wheel', handleScroll, { passive: false });
    });

    function clearImages() {
      layer.removeChildren();
      images = [];
      stage.batchDraw();
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const Shepherd = require('shepherd.js')
    let tour = null;

    function startTour() {
      if (tour) {
        tour.start();
        return;
      }
    }

    tour = new Shepherd.Tour({
      useModalOverlay: true,
    });

    steps=[{
      id: 'step1',
      title: 'Step 1',
      text: 'This is the first box. It contains a button to clear images.',
      attachTo: {
        element: '.boxy .box:nth-child(1)',
        on: 'bottom',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
      ],
    },
    {
      id: 'step2',
      title: 'Step 2',
      text: 'This is the second box. It contains a button for uploading files.',
      attachTo: {
        element: '.boxy .box:nth-child(2)',
        on: 'bottom',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
      ],
    },
    {
      id: 'step3',
      title: 'Step 3',
      text: 'This is the third box. It contains a button to save the image.',
      attachTo: {
        element: '.boxy .box:nth-child(3)',
        on: 'bottom',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
      ],
    },
    {
      id: 'step4',
      title: 'Step 4',
      text: 'This is the fourth box. It contains a button to go back to the index page.',
      attachTo: {
        element: '.boxy .box:nth-child(4)',
        on: 'bottom',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
      ],
    },
    {
      id: 'step5',
      title: 'Step 5',
      text: 'This is the opacity range slider.',
      attachTo: {
        element: '#opacityRange',
        on: 'top',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
      ],
    },
    {
      id: 'step6',
      title: 'Step 6',
      text: 'This is the canvas area',
      attachTo: {
        element: '#container',
        on: 'top',
      },
      classes: 'step-class',
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
      ],
    }
  ];

    tour.addSteps(steps);

    tour.defaultStepOptions = {
      classes: 'shepherd-theme-arrows',
      scrollTo: true,
      buttons: [
        {
          text: 'Next',
          action: tour.next,
        },
      ],
    };

  </script>
</body>
</html>
